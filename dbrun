#!/bin/bash
#
#	Start the mysql database
#
bin=`dirname $0`
. $bin/dbenv.sh


imagename=${CONTAINER_NAME}-image

#
#	Check we have SSH credentials on this machine
#
#
keyfile=~/.ssh/id_rsa.pub
key=`cat ${keyfile}`
if [ ! -r ${keyfile} ] ; then
	echo ""
	echo "Error: please set up SSH keys at ${keyfile}"
	echo ""
	echo "Cannot proceed."
	echo ""
	exit 1;
fi


#
#	Create the Dockerfile to build a new image.
#	This is the same as wnameless/mysql-phpmyadmin, but with SSH keys set up
#	for the current user, and with MySQL allowing access from outside localhost.
#
#
DOCKERFILE="/tmp/$(basename $0).$$.Dockerfile"
cat > ${DOCKERFILE} << END0
FROM wnameless/mysql-phpmyadmin
ENV HOME /root

# Set up SSH key
RUN mkdir /root/.ssh; echo "${key}" > /root/.ssh/authorized_keys; chmod 700 /root/.ssh; chmod 644 /root/.ssh/authorized_keys
#USER root

# Configure MySQL to allow non-localhost access (i.e. from outside it's Docker container)
RUN sed -i 's/^bind-address/#bind-address/' /etc/mysql/my.cnf
END0


#
#	Do the Docker build
#
#
cat ${DOCKERFILE}
docker build -t ${imagename} - < ${DOCKERFILE}
[ $? != 0 ] && exit $?


#
#	Start the Docker container
#
#
echo docker stop ${CONTAINER_NAME}
     docker stop ${CONTAINER_NAME}
echo docker rm ${CONTAINER_NAME}
     docker rm ${CONTAINER_NAME}
echo docker run --name ${CONTAINER_NAME} -p ${SSH_PORT}:22 -p ${HTTP_PORT}:80 -p ${DB_PORT}:3306 -d ${imagename}
     docker run --name ${CONTAINER_NAME} -p ${SSH_PORT}:22 -p ${HTTP_PORT}:80 -p ${DB_PORT}:3306 --rm ${imagename} &
[ $? != 0 ] && exit $?
sleep 2


#
#	Set MySQL permissions for root access beyond localhost.
#
#
echo ""
TFILE="/tmp/$(basename $0).$$.tmp"
cat > ${TFILE} <<END3
	echo ''
	echo 'Setting permissions for root database user.'
	TICK="\\\`"
	#cat << ENDSQL
	mysql -u root << ENDSQL

	CREATE DATABASE \${TICK}${DB_NAME}\${TICK} ;

	USE \${TICK}${DB_NAME}\${TICK} ;

	CREATE USER 'root'@'%' IDENTIFIED BY  '***';

	GRANT ALL PRIVILEGES ON  \${TICK}${DB_NAME}\${TICK} . * TO  'root'@'%' WITH GRANT OPTION ;

	SET PASSWORD FOR  'root'@'%' =  '';
ENDSQL
	[ $? != 0 ] && exit $?
	exit 0
END3

# Run the SQL commands on the server
#cat ${TFILE}
ssh root@${DOCKER_IP} -p ${SSH_PORT} /bin/bash -s < ${TFILE}
if [ $? == 0 ] ; then

	# Successful update
	rm ${TFILE}

	# Display a nice message
	echo ""
	echo ""
	echo "Applications can now access the database at:"
	echo "      Host: ${DOCKER_IP}"
	echo "      Port: ${HTTP_PORT}"
	echo ""
	echo "Access phpMyAdmin at: http://${DOCKER_IP}:${HTTP_PORT}/phpmyadmin"
	echo ""
	echo ""
	exit 0
else
	# Error return
	echo ""
	echo ""
	echo "Error: setting up the remote server failed."
	echo ""
	exit 1;
fi
